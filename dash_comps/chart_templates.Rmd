---
title: "templates-chart"
output: 
  flexdashboard::flex_dashboard:
    orientation: rows
    vertical_layout: fill
runtime: shiny
---


```{r}

library(dplyr)
library(plotly)
library(ggplot2)
#library(showtext)

# Chart on DMP templates.

# Users can select data on a chart to show in the rendered
# data table (see 'datatable_main.Rmd'). It uses the event_data function
# which can only function well if the chart is rendered by plotly. To track
# whether a chart is rendered we add a function that takes reactive values
# and are updated at the end of the plot specification. This function is used
# in 'datatable_main.Rmd' to get values of event_data.

plot_rendered_templ <- reactiveVal()


# Start the plot render. 

renderPlotly({
  
  # Update our tracking function to FALSE as the plot is not rendered yet, it
  # will remain FALSE unless we update it later. 
  
  plot_rendered_templ(FALSE)
  
  
  # Side note:
  # In case a different font then default should be used:
  # 
  # font_add('sans-open', 'www/Open_Sans/OpenSans-Regular.ttf')
  # showtext_auto()
  # 
  # Then use "family = 'sans-open'" wherever you are specifying text, for example:
  # theme(text = element_text(family = "sans-open")) 
   
  
  # Create a frequency table of the desired output for a bit easier plotting.

  template_freq <-  filtered_data() %>% 

                    count(., template, .drop = FALSE) 

  
  # Find the max number of DMPs, add 20, and round to the nearest 10. This value 
  # is used for setting the maximum Y axis value in the charts. 
  
  maxn <-  as.numeric(max(template_freq$n) + 20) %>% 
  
           round(digits = -1)

  
  # Plot the graph with ggplot. ggplot is used instead of plotly as ggplot
  # has a nice grammar to work with, this graph can also just be created
  # with plotly.
  # 
  # ggplot the dataframe of choice with mapping aesthetics x and y values +
  # 
  # geom_col - Specify that the geometry (type of chart) is a column. 
  #            Specify that we don't want a stacked column through 'dodge' or 
  #            position_dodge(number)
  #            Specify the fill colour and the outline colour ('black'). +
  # 
  # theme - Specify some formatting of the plot using theme:
  #         * plot.background - create white background of entire figure
  #         * panel.background - create white background of plot
  #         * strip.background - remove background colour from facet titles.
  #         * axis.line - specify linetype, size, and colour of axes
  #         * panel.grid.major.y - specify the line properties of the major tick 
  #           grid lines y axis (horizontal lines through plot)
  #         * panel.grid.major.x - specify the line properties of the major tick
  #           grid lines x axis (vertical lines through plot), it is left blank to not 
  #           show the vertical lines through the plot.
  #         * plot.title - specify the format of the plot title (hjust = horizontal
  #           adjustment set to half of the figure (i.e,centered in figure outline)
  #         * axis.text.x - specify x axis text: colour, size, angle, and horizontal adjustment
  #           (it is left blank as labels are added to the columns).
  #         * axis.text.y - specify y axis text: colour, size 
  #         * plot.margin - add plot margins specifically required when using ggplot with plotly 
  #           as for some reason it would not render properly (something to do with flexdashboard
  #           filling 100% of panel and ggplot not recognizing the margins). Margin order is 
  #           top, right, bottom, left +
  # 
  # labs - specify labels as xax title, yax title, and plot title +
  # 
  # geom-text - add xax data labels to each column with a vertical adjust (nudge) so that labels are
  #             placed above columns. Note that some labels are long and they are wrapped using
  #             str_wrap so that the labels do not overlap the columns. Geom label does not work in
  #             plotly / ggplotly, hence geom_text.
  #             
  # geom-text - add a second text label consisting of the Y values of each column. They are vertically
  #             adjusted so that the labels fall within the bars.  Geom label does not work in
  #             plotly / ggplotly, hence geom_text. +
  # 
  # scale_y_continuous - set the breaks of the Y axis (here 0 to maxn with 20 increments), 
  #                      limit the Y axis (0 to maxn), and specify no padding of whitespace on the 
  #                      y axis by setting the expand to 0 
  
  templggpl <- ggplot(template_freq, 
                      mapping = aes(x = template, y = n)) +
  
               geom_col(fill = "#337ab7", 
                        position = 'dodge', 
                        colour = 'black') +
              
               theme(plot.background = element_rect(fill = "white"),
                     panel.background = element_rect(fill = "white"),
                     strip.background = element_blank(),
                     axis.line = element_line(linewidth = 0.5, 
                                              colour = "black", 
                                              linetype = 1),
                     panel.grid.major.y = element_line(linewidth = 0.2, 
                                                       colour = "gray", 
                                                       linetype = 1),
                     panel.grid.major.x = element_blank(),
                     plot.title = element_text(hjust = 0.5, 
                                               size = 18, 
                                               colour = 'black'),
                     axis.text.x = element_blank(),
                     axis.text.y = element_text(colour = 'black', 
                                                size = 11),
                     plot.margin = unit(c(0, 0, 0.6, 0.5), "cm")) + 
              
               labs(x = NULL, 
                    y = 'Number of DMPs', 
                    title = 'DMP templates') +
              
               geom_text(aes(label = stringr::str_wrap(template, 5)), 
                         colour = "black", 
                         size = 2.8, 
                         nudge_y = 6) +
               
               geom_text(aes(label = n), 
                         colour = "white", 
                         size = 3, 
                         nudge_y = -7) +
              
               scale_y_continuous(breaks = seq(0, maxn, by = 20), 
                                  limits = c(0, maxn), 
                                  expand = c(0,0))  
 
  
  # Convert the ggplot to a plotly object to make the chart interactive when hovering over columns
  # or be able to zoom in and select data. 
  # Indicate that the user can select columns using dragging.
  # Add some customization by removing plotly logo and specifically requesting certain buttons 
  # (in order of appearance: save as png, be able to zoom in and zoom out, select data by drag
  # selecting columns in the plot area. 
  # Finally register events when selections are made (this is used in 'datatable_main.Rmd').
  
  plot_tmpl <- ggplotly(templggpl, source = 'template_chart') %>% 
    
               layout(dragmode = "select") %>% 
   
               config(displayModeBar = TRUE, 
                      displaylogo = FALSE, 
                      modeBarButtons = list(list("toImage", 
                                                 "zoom2d",
                                                 "select2d"))) %>% 
  
               event_register("plotly_selected")
  
  
  # Update our tracking function. Not really sure how it works, but it works.
  
  session$onFlushed(\() plot_rendered_templ(TRUE), once = FALSE)
  
  
  # Plot the plot
  
  plot_tmpl

})



     
```
